---
title: "Making a plot of December snowfall data in NJ with R's ggplot2 & rnoaa"
author: "Kevin Zolea"
date: "2019-12-20"
slug: 
categories:
  - R
tags:
  - R
  - ggplot2
image:
  placement: 1
  caption: ''
  focal_point: ''
  preview_only: false

summary: Using the rnoaa package to get weather data into R and plot with ggplot2
---
---
## What is this post about?

While driving to work today, I had a conversation with my girlfriend about the possibility of having a white Christmas this year. As someone who is passionate about the environment and data analysis, I was eager to investigate the subject further. Although I had already read some articles on this topic, I decided to make it a fun project by analyzing historical data using R. In this post, I will demonstrate how you can import data into R and create an impressive plot with the help of the ```ggplot2``` package. Since I reside in New Jersey, I will be examining data from local weather stations in order to gain a better understanding of the likelihood of a white Christmas in the state.

## Acquiring the data

There are numerous online resources available to access weather data. However, for the purpose of this post, and with the aim to help others, I will be using the [rnoaa](https://docs.ropensci.org/rnoaa/index.html){target="_blank"} package. This package serves as an interface to several of NOAA's data sources and is maintained by [rOpenSci](https://ropensci.org/){target="_blank"}. One of the best features of this package is its ability to retrieve data from NOAA's API and import it into R in a user-friendly format. The package eliminates the need to understand how to make requests to NOAA's API, saving a significant amount of time. The first step is to request a key to access NOAA's API, which can be done by providing your email address [here](https://www.ncdc.noaa.gov/cdo-web/token){target="_blank"}. Within a few seconds, you should receive an email with your key.

Now that we have our key, we can access any of the datasets available in ```rnoaa```. The complete list of data sets can be found on [rnoaa's website](https://docs.ropensci.org/rnoaa/index.html){target="_blank"}. For this blog post, I will be accessing data from the Global Historical Climate Network (GHCN) dataset. This dataset includes daily land surface observations from weather stations worldwide, making it an excellent resource for obtaining snowfall data for the past decade. To retrieve data from the desired weather stations, we can use the ```meteo_pull_monitors``` function, which takes a vector of one or more weather station IDs from the GHCN dataset and consolidates them into a single data frame. Before using this function, however, we need to determine which stations we want data from. We can do this by using the ```ncdc_stations``` function and providing the FIPS code for Middlesex County in New Jersey.
```


# If rnoaa isn't installed use the following first before trying to load it 
# install.packages('rnoaa')

library(rnoaa)

key<-"GmjHeChrRWYy..."

stations <- ncdc_stations(datasetid='GHCND', 
              locationid='FIPS:34023',
              token = key)

stations$data  


```
```{r echo=FALSE}
library(rnoaa)

key<-"GmjHeChrRWYyAcMWTFhNuYQcHYvPSrzw"

stations <- ncdc_stations(datasetid='GHCND', 
                          locationid='FIPS:34023',
                          token = key)

head(stations$data)

```

This information provides us with the necessary details to begin pulling the data. We can obtain information on the minimum and maximum dates, latitude, station name, station ID, and more, giving us an idea of the data available for the stations within our area of interest. To perform my desired analysis, I aim to find the stations within Middlesex County, NJ, that have at least ten years of data. Based on the available information, it appears that the following stations meet this criteria:
```
middlesex_stations<-c("US1NJMD0062","US1NJMD0002","US1NJMD0063","US1NJMD0009",
            "US1NJMD0024","GHCND:US1NJMD0028")
```
## Pull data from NOAA's API with ```meteo_pull_monitors```

Now it's time to use the ```meteo_pull_monitors``` function! This function (which is the main function to get the data) has a few arguments you can give it. A **brief** description of each one is below:

* monitors - A character vector listing the station IDs for all weather stations the user would like to pull
* keep_flags - TRUE/FALSE to keep any flags that each weather variable might have associated with the data
* date_min - A character string giving the earliest date the user would like in the final output formatted as "yyyy-mm-dd"
* date_max - A character string giving the latest date the user would like in the final output formatted as "yyyy-mm-dd"
* var - A character vector specifying the weather parameters to keep in the final data (ex: ```"SNOW"```) A full list of the different possible weather variations can be found [here](https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt){target="_blank"}

```
middlesex_snow<-meteo_pull_monitors(monitors=middlesex_stations,var = "SNOW")

```

Taking a look at the data frame we should see something like this:
```{r echo=FALSE, message=FALSE}
library(rnoaa)
key<-"GmjHeChrRWYyAcMWTFhNuYQcHYvPSrzw"

middlesex_stations<-c("US1NJMD0002","US1NJMD0009",
            "US1NJMD0024","GHCND:US1NJMD0028")
middlesex_snow<-meteo_pull_monitors(monitors=middlesex_stations,var = "SNOW")
head(middlesex_snow)
```

From my very ***basic*** understanding of the package, I believe the warning message above is because the station ```GHCND:US1NJMD0028``` doesn't have the variable ```"SNOW"```. So this now leads us with only three stations to look at it. 

## Filter the data frame with ```dplyr```

Next, I want to filter the data frame to only include data for the December months, get rid of any missing data, and convert mm to inches. I am going to do this with the ```dplyr``` package. The ```dplyr``` package is apart of the ```tidyverse``` and is a great resource for data manipulation. You can learn more about the ```dplyr``` package [here](https://dplyr.tidyverse.org/){target="_blank"}

```
library(tidyverse)
library(lubridate)
library(measurements) # used to convert from mm to in

middlesex_stations<-middlesex_snow%>%
  dplyr::mutate(month = lubridate::month(date), snow = conv_unit(snow,"mm","inch"))%>%
  dplyr::filter(!snow == is.na(snow),month == 12)

```
After these filters, this leaves us with a data frame consisting of 39 obs. of 4 variables

## Make plot with ```ggplot2```

One of the most popular data visualization in R is with ```ggplot2```. I personally like ```ggplot2``` because of how easy it is to learn/use and how great it works with the rest of the ```tidyverse```. To learn more about ```ggplot2``` head over to the [website](https://ggplot2.tidyverse.org/){target="_blank"}. With just two lines of code we can make a plot with the data frame we pulled from ```rnoaa``` above. 

```
library(tidyverse)


ggplot(data = middlesex_stations,aes(x=date,y=snow,color = id))+
  geom_line()

```
```{r echo=FALSE,message=FALSE,warning=FALSE}
library(rnoaa)
library(tidyverse)
library(measurements)

#middlesex_stations<-c("US1NJMD0002","US1NJMD0009",
      #      "US1NJMD0024","GHCND:US1NJMD0028")
#middlesex_snow<-meteo_pull_monitors(monitors=middlesex_stations,var = "SNOW")

middlesex_stations<-middlesex_snow%>%
  dplyr::mutate(month = lubridate::month(date), snow = conv_unit(snow,"mm","inch"))%>%
  dplyr::filter(!snow == is.na(snow),month == 12)

ggplot(data = middlesex_stations,aes(x=date,y=snow,color = id))+
  geom_line()


```

As depicted by the plot, these three stations have not experienced significant snowfall in December within the last ten years. However, there are some gaps in the dataset, and this may not be the optimal dataset for this analysis. Nonetheless, it serves the purpose of this blog post. One notable observation from the plot is the snowfall total of 22.9 in. for US1NJMD0002 in 2010. This snowstorm, referred to as the "Boxing Day Blizzard of 2010," was a fast-developing nor'easter that wreaked havoc across New Jersey, leaving the snowfall total exceptionally high for that year. Most snowfall events recorded in the past decade did not surpass 5 in., making the 22.9 in. total very noticeable in the plot. Additionally, it's worth noting that the data frame shows no snowfall events on Christmas day in the past ten years.

## Customize your new ggplot

Let's take it a step further and customize the plot we just made. For fun, let's try and find a picture of snow from the web and add it to the background. We can do this by using the [```ggimage```](https://cran.r-project.org/web/packages/ggimage/vignettes/ggimage.html) package. The ```ggimage``` package is a great package to use images in ```ggplot2```.

#### Add background image from web to plot

```
library(ggimage)

p<-ggplot(data = middlesex_stations,aes(x=date,y=snow,color = id))+
  geom_line()

img<-"http://funny-photo.s3.amazonaws.com/preview/snow_effect/falling_snow_effect.jpeg"
ggbackground(p,img)

```
```{r echo=FALSE,message=FALSE,warning=FALSE}
library(rnoaa)
library(tidyverse)
library(measurements)
library(ggimage)
library(ggpubr)

key<-"GmjHeChrRWYyAcMWTFhNuYQcHYvPSrzw"

middlesex_stations<-c("US1NJMD0002","US1NJMD0009",
            "US1NJMD0024","GHCND:US1NJMD0028")
middlesex_snow<-meteo_pull_monitors(monitors=middlesex_stations,var = "SNOW")


middlesex_stations<-middlesex_snow%>%
  dplyr::mutate(month = lubridate::month(date), snow = conv_unit(snow,"mm","inch"))%>%
  dplyr::filter(!snow == is.na(snow),month == 12)


p<-ggplot(data = middlesex_stations,aes(x=date,y=snow,color = id))+
  geom_line(size=2)

img<-"http://funny-photo.s3.amazonaws.com/preview/snow_effect/falling_snow_effect.jpeg"

ggbackground(p,img)
```

There are many more ways to customize the plot, but we'll leave that for another day. One of the great features of ```ggplot2``` is its versatility, allowing for endless creativity in plotting data. I hope you found this post informative and useful. If you have any questions, comments, or concerns, please feel free to leave a comment below. Thank you!





